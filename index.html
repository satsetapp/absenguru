<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Title Judul Aplikasi -->
    <title>E-Absensi Guru v7.3</title>

    <!-- Open Graph / WhatsApp Preview -->
    <meta property="og:title" content="E-Absensi Guru v7.3">
    <meta property="og:description"
        content="Aplikasi absensi guru berbasis web dengan sistem kalender kerja fleksibel. Cepat, modern, dan responsif untuk HP & Laptop.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://satsetapp.github.io/absenguru/">
    <meta property="og:image" content="https://satsetapp.github.io/absenguru/logo.png">

    <!-- Optional tapi disarankan -->
    <meta property="og:site_name" content="E-Absensi Guru v7.3">
    <meta property="og:locale" content="id_ID">

    <!-- Favicon Browser -->
    <link rel="icon" type="image/png" href="logo.png">

    <!-- iOS Home Screen -->
    <link rel="apple-touch-icon" href="logo.png">

    <!-- Theme Color -->
    <meta name="theme-color" content="#0f172a">
    <meta name="msapplication-TileColor" content="#0f172a">

    <!-- Manifest untuk PWA -->
    <link rel="manifest" href="manifest.json">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Config Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: { glass: 'rgba(30, 41, 59, 0.7)' }
                }
            }
        }
    </script>

    <style>
        /* Base Styles */
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }

        body {
            background-color: #0f172a;
            background-image: radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0, transparent 50%), radial-gradient(at 100% 0%, rgba(236, 72, 153, 0.15) 0, transparent 50%);
            color: #f8fafc;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glassmorphism Panel */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* Inputs */
        .glass-input {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.2);
            color: white;
            transition: all 0.3s ease;
        }

        .glass-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        /* Button Gradient */
        .btn-gradient {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            transition: all 0.3s ease;
        }

        .btn-gradient:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(168, 85, 247, 0.4);
        }

        .btn-gradient:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: #334155;
        }

        /* Toast & Loader Animation */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        /* Calendar Colors */
        .calendar-day {
            min-height: 85px;
            transition: all 0.2s ease;
        }

        .calendar-day:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .day-working {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .day-mandatory-off {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .day-optional-off {
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.2);
        }

        .day-attended {
            background: rgba(34, 197, 94, 0.25);
            border: 1px solid rgba(34, 197, 94, 0.5);
        }

        /* PERBAIKAN: Hari ini hanya outline di kotak luar, bukan di angka */
        .day-today {
            border-width: 2px !important;
            border-color: #6366f1 !important;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
        }

        /* Hapus class .day-today dari angka */
        .day-number-today {
            /* Hanya untuk styling angka hari ini, tanpa border */
            color: #ffffff !important;
            font-weight: bold;
        }

        /* Custom Checkbox */
        .custom-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #4b5563;
            border-radius: 4px;
            background: rgba(30, 41, 59, 0.5);
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .custom-checkbox:checked {
            background: #6366f1;
            border-color: #6366f1;
        }

        .custom-checkbox:checked::after {
            content: "✓";
            position: absolute;
            color: white;
            font-size: 14px;
            font-weight: bold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4b5563;
            border-radius: 24px;
            transition: .4s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
        }

        input:checked+.toggle-slider {
            background-color: #6366f1;
        }

        input:checked+.toggle-slider:before {
            transform: translateX(24px);
        }

        /* Scrollbar custom */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.7);
        }

        /* Animasi */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* PERBAIKAN: Fix for modal overlay - Z-INDEX TINGGI */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 9999;
            /* PERBAIKAN: Naikkan z-index */
            display: flex;
            /* PERBAIKAN: Gunakan flex untuk centering */
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
            width: 100%;
            max-width: 400px;
        }

        /* PERBAIKAN: Pastikan tombol logout bisa diklik */
        .logout-btn {
            cursor: pointer !important;
            pointer-events: auto !important;
            position: relative;
            z-index: 1;
        }

        /* PERBAIKAN: Style untuk hari terlewat */
        .day-missed {
            background: rgba(30, 41, 59, 0.3) !important;
            /* Background lebih gelap/transparan */
            border: 1px solid rgba(148, 163, 184, 0.3) !important;
            /* Border abu-abu tipis */
            color: #94a3b8 !important;
            /* Warna teks abu-abu */
        }

        /* Pastikan hover effect tetap ada */
        .day-missed:hover {
            background: rgba(30, 41, 59, 0.5) !important;
            border-color: rgba(148, 163, 184, 0.5) !important;
        }
    </style>
</head>

<body class="antialiased">

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay"
        class="fixed inset-0 z-50 bg-slate-900/90 hidden flex flex-col items-center justify-center backdrop-blur-sm">
        <div class="loader w-12 h-12 mb-4"></div>
        <p class="text-indigo-300 font-medium animate-pulse" id="loading-text">Memproses...</p>
    </div>

    <!-- ================= LOGIN PAGE ================= -->
    <section id="login-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-8 rounded-3xl relative overflow-hidden">
            <!-- Background Blobs -->
            <div class="absolute -top-10 -left-10 w-40 h-40 bg-indigo-500 rounded-full blur-[80px] opacity-20"></div>
            <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-pink-500 rounded-full blur-[80px] opacity-20"></div>

            <div class="text-center mb-8 relative z-10">
                <!-- LOGO CUSTOM -->
                <img src="logo.png" alt="Logo App"
                    class="w-20 h-20 mx-auto mb-4 object-contain drop-shadow-2xl shadow-indigo-500/30">

                <h1 class="text-3xl font-bold text-white tracking-tight">E-Absensi Guru v7.3</h1>
                <p class="text-slate-400 mt-2 text-sm">Masuk dengan akun anda</p>
                <p class="text-indigo-400 text-xs mt-1 animate-pulse-slow">
                    <i class="fa-solid fa-calendar-star mr-1"></i>Sistem Kalender Fleksibel!
                </p>
            </div>

            <form id="login-form" class="space-y-5 relative z-10">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Username /
                        Email</label>
                    <div class="relative">
                        <i class="fa-solid fa-user absolute left-4 top-3.5 text-slate-500"></i>
                        <input type="text" id="login-user"
                            class="glass-input w-full rounded-xl py-3 pl-10 pr-4 text-sm placeholder-slate-600"
                            placeholder="Username / Email" required autocomplete="username">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Password</label>
                    <div class="relative">
                        <i class="fa-solid fa-lock absolute left-4 top-3.5 text-slate-500"></i>
                        <input type="password" id="login-pass"
                            class="glass-input w-full rounded-xl py-3 pl-10 pr-12 text-sm placeholder-slate-600"
                            placeholder="•••••" required autocomplete="current-password">

                        <!-- TOGGLE MATA -->
                        <button type="button" id="toggle-password"
                            class="absolute right-4 top-3.5 text-slate-500 hover:text-white transition-colors focus:outline-none">
                            <i class="fa-solid fa-eye" id="eye-icon"></i>
                        </button>
                    </div>
                </div>

                <button type="submit"
                    class="btn-gradient w-full py-3.5 rounded-xl font-bold text-white shadow-lg shadow-indigo-500/25 flex items-center justify-center gap-2 active:scale-95 transition-transform">
                    Masuk Aplikasi <i class="fa-solid fa-arrow-right"></i>
                </button>
            </form>
        </div>
    </section>

    <!-- ================= APP DASHBOARD ================= -->
    <div id="app-page" class="hidden min-h-screen flex flex-col md:flex-row relative">

        <!-- Sidebar Desktop (Kiri) - Hanya tampil di Desktop -->
        <nav
            class="glass-panel hidden md:flex md:w-64 md:h-screen border-r border-white/10 flex-col justify-between fixed left-0 top-0 bottom-0 z-40">
            <div class="p-6 border-b border-white/5">
                <div class="flex items-center gap-3">
                    <!-- LOGO KECIL HEADER -->
                    <img src="logo.png" alt="Logo" class="w-8 h-8 rounded-lg object-contain border border-white/10">
                    <span class="font-bold text-lg text-white tracking-tight">E-Absensi v7.3</span>
                </div>
            </div>

            <!-- AREA MENU DESKTOP -->
            <div class="flex flex-col justify-between h-auto p-4 gap-2 flex-1">
                <div class="space-y-2">
                    <button onclick="switchTab('home')" id="btn-tab-home"
                        class="nav-item active flex flex-row items-center gap-3 px-4 py-3 rounded-xl text-white bg-white/10 transition-all w-full text-left">
                        <i class="fa-solid fa-house text-base"></i>
                        <span class="text-sm font-medium">Absensi</span>
                    </button>

                    <button onclick="switchTab('recap')" id="btn-tab-recap"
                        class="nav-item flex flex-row items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all w-full text-left">
                        <i class="fa-solid fa-list-ul text-base"></i>
                        <span class="text-sm font-medium">Riwayat</span>
                    </button>

                    <button onclick="switchTab('calendar')" id="btn-tab-calendar"
                        class="nav-item flex flex-row items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all w-full text-left">
                        <i class="fa-solid fa-calendar-days text-base"></i>
                        <span class="text-sm font-medium">Kalender Kerja</span>
                    </button>
                </div>

                <!-- Logout Desktop - PERBAIKAN: Tambah class logout-btn -->
                <div class="mt-auto pt-4 border-t border-white/5">
                    <button onclick="openLogoutModal()"
                        class="logout-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-red-400 hover:bg-red-500/10 transition-all text-sm font-medium">
                        <i class="fa-solid fa-right-from-bracket"></i> Keluar
                    </button>
                </div>
            </div>
        </nav>

        <!-- Bottom Nav Mobile - Hanya tampil di Mobile -->
        <nav class="glass-panel md:hidden fixed bottom-0 left-0 right-0 z-40 w-full border-t border-white/10">
            <div class="flex justify-around items-center h-16 p-2 gap-2">
                <button onclick="switchTab('home')" id="btn-tab-home-mobile"
                    class="nav-item-mobile active flex flex-col items-center justify-center gap-1 rounded-xl text-white bg-white/10 transition-all flex-1 w-full py-2">
                    <i class="fa-solid fa-house text-lg"></i>
                    <span class="text-[10px] font-medium">Absensi</span>
                </button>

                <button onclick="switchTab('recap')" id="btn-tab-recap-mobile"
                    class="nav-item-mobile flex flex-col items-center justify-center gap-1 rounded-xl text-slate-400 transition-all flex-1 w-full py-2">
                    <i class="fa-solid fa-list-ul text-lg"></i>
                    <span class="text-[10px] font-medium">Riwayat</span>
                </button>

                <button onclick="switchTab('calendar')" id="btn-tab-calendar-mobile"
                    class="nav-item-mobile flex flex-col items-center justify-center gap-1 rounded-xl text-slate-400 transition-all flex-1 w-full py-2">
                    <i class="fa-solid fa-calendar-days text-lg"></i>
                    <span class="text-[10px] font-medium">Kalender</span>
                </button>

                <!-- PERBAIKAN: Tombol logout mobile -->
                <button onclick="openLogoutModal()"
                    class="logout-btn flex flex-col items-center justify-center gap-1 rounded-xl text-red-400 hover:bg-red-500/10 transition-all flex-1 w-full py-2">
                    <i class="fa-solid fa-right-from-bracket text-lg"></i>
                    <span class="text-[10px] font-medium">Keluar</span>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8 pb-20 md:pb-8 overflow-y-auto relative z-0 md:ml-64">
            <!-- HEADER DENGAN LOGO -->
            <header class="flex justify-between items-center mb-4 md:mb-8">
                <div class="flex items-center gap-3">
                    <!-- LOGO KECIL HEADER -->
                    <img src="logo.png" alt="Logo"
                        class="w-8 h-8 rounded-lg object-contain border border-white/10 hidden md:block">

                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-white">Halo, <span id="user-name-display"
                                class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-pink-400">User</span>
                        </h1>
                        <p id="date-display" class="text-slate-400 text-xs md:text-sm mt-1"></p>
                    </div>
                </div>
                <div class="flex items-center gap-3">

                    <!-- TOMBOL INSTALL PWA (PERBAIKAN: Default tampil setelah cek kondisi) -->
                    <button id="btn-install-pwa" onclick="installApp()"
                        class="hidden px-3 py-1.5 text-xs font-bold text-white bg-green-600 hover:bg-green-500 rounded-full flex items-center gap-2 transition-all shadow-lg shadow-green-600/20 animate-pulse">
                        <i class="fa-solid fa-download"></i> Install App
                    </button>

                    <button onclick="refreshData()"
                        class="w-10 h-10 rounded-full glass-panel flex items-center justify-center text-slate-400 hover:text-white hover:scale-110 transition-all active:scale-95">
                        <i class="fa-solid fa-rotate" id="icon-refresh"></i>
                    </button>
                </div>
            </header>

            <!-- TAB: HOME (ABSENSI) -->
            <div id="tab-home" class="space-y-6">

                <!-- UI RINGKAS (1 BARIS) -->
                <div
                    class="glass-panel rounded-2xl p-4 flex items-center justify-between divide-x divide-white/10 shadow-lg shadow-indigo-500/5">

                    <!-- Total Hadir -->
                    <div class="flex-1 text-center px-2 min-w-[80px]">
                        <p class="text-[10px] uppercase text-green-400 font-bold tracking-wider mb-1">Hadir</p>
                        <h3 class="text-2xl font-bold text-green-400" id="stat-total">0</h3>
                    </div>

                    <!-- Tidak Hadir -->
                    <div class="flex-1 text-center px-2 min-w-[80px]">
                        <p class="text-[10px] uppercase text-yellow-400 font-bold tracking-wider mb-1">Tidak Hadir</p>
                        <h3 class="text-2xl font-bold text-white" id="stat-absent">0</h3>
                    </div>

                    <!-- Terlambat -->
                    <div class="flex-1 text-center px-2 min-w-[80px]">
                        <p class="text-[10px] uppercase text-red-400 font-bold tracking-wider mb-1">Terlambat</p>
                        <h3 class="text-2xl font-bold text-white" id="stat-late">0</h3>
                    </div>
                </div>

                <!-- ACTION AREA -->
                <div class="glass-panel p-6 md:p-8 rounded-3xl text-center relative border border-white/5">
                    <div
                        class="absolute inset-0 bg-gradient-to-b from-white/5 to-transparent rounded-3xl pointer-events-none">
                    </div>

                    <h2 class="text-sm md:text-lg font-medium text-slate-300 mb-1">Waktu Sekarang</h2>
                    <p id="live-clock"
                        class="text-5xl md:text-6xl font-mono font-bold text-white mb-6 tracking-tighter">00:00</p>

                    <button id="btn-absen" onclick="doAbsen()"
                        class="btn-gradient w-full max-w-[200px] h-56 md:h-auto md:py-4 rounded-full text-xl font-bold flex flex-col items-center justify-center gap-2 mx-auto shadow-2xl shadow-indigo-500/20 active:scale-95 transition-all relative z-10">
                        <i class="fa-solid fa-fingerprint text-4xl md:text-3xl animate-pulse"></i>
                        <span>ABSEN</span>
                    </button>

                    <!-- BUTTON TIDAK HADIR -->
                    <div class="mt-6 relative z-10">
                        <button onclick="openAbsenceModal()"
                            class="text-xs text-slate-400 hover:text-slate-200 underline decoration-dotted underline-offset-4">
                            Tidak bisa hadir hari ini?
                        </button>
                    </div>

                    <div id="status-container" class="mt-6 hidden relative z-10">
                        <div
                            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-800/80 border border-white/10 backdrop-blur-sm">
                            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse" id="status-dot"></span>
                            <span class="text-xs md:text-sm font-medium text-slate-300">Status: <b id="status-text"
                                    class="text-white">-</b></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: RECAP (RIWAYAT) -->
            <div id="tab-recap" class="hidden space-y-6">
                <div class="glass-panel rounded-2xl overflow-hidden">
                    <div
                        class="p-4 md:p-6 border-b border-white/10 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <h3 class="text-lg font-bold text-white"><i
                                class="fa-solid fa-clock-rotate-left text-pink-500 mr-2"></i>Riwayat Absensi</h3>
                        <div class="flex gap-2 w-full md:w-auto">
                            <select id="filter-month" onchange="renderRecap()"
                                class="glass-input px-3 py-2 rounded-lg text-sm w-full md:w-auto"></select>
                            <select id="filter-year" onchange="renderRecap()"
                                class="glass-input px-3 py-2 rounded-lg text-sm w-24"></select>
                        </div>
                    </div>

                    <!-- RINGKASAN DI ATAS TABEL -->
                    <div class="grid grid-cols-3 gap-2 p-4 border-b border-white/10 bg-slate-800/50">
                        <div class="text-center p-2 rounded bg-slate-700/50">
                            <p class="text-[9px] uppercase text-green-400 font-bold tracking-wider mb-1">Hadir</p>
                            <h3 class="text-xl font-bold text-green-400" id="recap-stat-total">0</h3>
                        </div>
                        <div class="text-center p-2 rounded bg-slate-700/50">
                            <p class="text-[9px] uppercase text-yellow-400 font-bold tracking-wider mb-1">Tidak Hadir
                            </p>
                            <h3 class="text-xl font-bold text-yellow-400" id="recap-stat-absent">0</h3>
                        </div>
                        <div class="text-center p-2 rounded bg-slate-700/50">
                            <p class="text-[9px] uppercase text-red-400 font-bold tracking-wider mb-1">Terlambat</p>
                            <h3 class="text-xl font-bold text-red-400" id="recap-stat-late">0</h3>
                        </div>
                    </div>

                    <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-800/50 sticky top-0 backdrop-blur-md">
                                <tr class="text-slate-400 text-xs uppercase tracking-wider">
                                    <th class="p-4 font-semibold">Hari, Tanggal</th>
                                    <th class="p-4 font-semibold">Jam</th>
                                    <th class="p-4 font-semibold">Status</th>
                                </tr>
                            </thead>
                            <tbody id="recap-body" class="divide-y divide-white/5 text-sm text-slate-300"></tbody>
                        </table>
                        <div id="recap-empty" class="hidden p-8 text-center text-slate-500">
                            <i class="fa-regular fa-folder-open text-3xl mb-2 opacity-50"></i>
                            <p class="text-sm">Tidak ada data absensi pada periode ini.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: CALENDAR (KALENDER KERJA) -->
            <div id="tab-calendar" class="hidden space-y-6">
                <!-- PERIODE DAN STATISTIK -->
                <div class="glass-panel rounded-2xl p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                                <i class="fa-solid fa-calendar-check text-indigo-500"></i>
                                Kalender Kerja Periode
                            </h3>
                            <p id="calendar-period-display" class="text-slate-400 text-sm mt-1">26 Des 2025 - 25 Jan
                                2026</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="prevCalendarMonth()"
                                class="glass-panel px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-white/5">
                                <i class="fa-solid fa-chevron-left"></i>
                                <span>Bulan Sebelumnya</span>
                            </button>
                            <button onclick="nextCalendarMonth()"
                                class="glass-panel px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-white/5">
                                <span>Bulan Selanjutnya</span>
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- STATISTIK UTAMA -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- STATISTIK HARI -->

                        <div class="glass-panel p-5 rounded-xl">
                            <h4 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Statistik Hari
                            </h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-slate-300">Total Hari</span>
                                    <span class="font-bold text-white" id="stat-total-days">31</span>
                                </div>

                                <!-- TAMBAHKAN BARIS INI: Total Wajib Absen -->

                                <div class="flex justify-between items-center">
                                    <span class="text-slate-300">Hari Kerja Wajib</span>
                                    <span class="font-bold text-green-400" id="stat-mandatory-working">16</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-slate-300">Hari Libur Optional</span>
                                    <span class="font-bold text-orange-400" id="stat-optional-off">0</span>
                                </div>
                                <div class="flex justify-between items-center border-t border-white/10 pt-3">
                                    <span class="text-slate-300 font-bold">Total Bisa Absen</span>
                                    <span class="font-bold text-blue-400" id="stat-can-attend">31</span>
                                </div>
                            </div>
                        </div>

                        <!-- STATISTIK KEHADIRAN -->
                        <div class="glass-panel p-5 rounded-xl">
                            <h4 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Statistik
                                Kehadiran</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-slate-300">Total Hadir</span>
                                    <span class="font-bold text-white" id="stat-total-attended">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-slate-300">Target Minimum</span>
                                    <span class="font-bold text-green-400">20 hari</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-slate-300">Progress</span>
                                    <span class="font-bold text-white" id="stat-progress">0/20</span>
                                </div>
                                <div class="mt-4">
                                    <div class="flex justify-between text-xs text-slate-400 mb-1">
                                        <span>Progress Kehadiran</span>
                                        <span id="stat-progress-percent">0%</span>
                                    </div>
                                    <div class="w-full bg-slate-700 rounded-full h-2">
                                        <div id="progress-bar"
                                            class="bg-green-500 h-2 rounded-full transition-all duration-500"
                                            style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RINGKASAN CEPAT -->
                    <!-- Di bagian RINGKASAN CEPAT - Tambah statistik baru -->
                    <!-- Di bagian RINGKASAN CEPAT - Tambah statistik Sisa Libur Optional -->
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-5 gap-4"> <!-- Ubah dari 4 ke 5 kolom -->
                        <div class="glass-panel p-4 rounded-xl flex items-center justify-between">
                            <div>
                                <p class="text-xs text-slate-400" title="Total hari yang sudah absen">Sudah Hadir</p>
                                <h4 class="text-xl font-bold text-green-400" id="stat-attended-days">0</h4>
                            </div>
                            <i class="fa-solid fa-check-circle text-green-500 text-2xl"></i>
                        </div>

                        <div class="glass-panel p-4 rounded-xl flex items-center justify-between">
                            <div>
                                <p class="text-xs text-slate-400"
                                    title="Sisa hari yang masih bisa digunakan untuk absen">Sisa Kesempatan Absen</p>
                                <h4 class="text-xl font-bold text-yellow-400" id="stat-not-attended">0</h4>
                            </div>
                            <i class="fa-solid fa-clock text-yellow-500 text-2xl"></i>
                        </div>

                        <!-- TAMBAH INI: Sisa Libur Optional -->
                        <div class="glass-panel p-4 rounded-xl flex items-center justify-between">
                            <div>
                                <p class="text-xs text-slate-400" title="Hari libur optional yang masih tersisa">Sisa
                                    Libur Optional</p>
                                <h4 class="text-xl font-bold text-orange-400" id="stat-remaining-optional">0</h4>
                            </div>
                            <!-- TAMBAH ID PADA ICON -->
                            <i class="fa-solid fa-calendar-star text-orange-500 text-2xl" id="optional-icon"></i>
                        </div>

                        <div class="glass-panel p-4 rounded-xl flex items-center justify-between">
                            <div>
                                <p class="text-xs text-slate-400"
                                    title="Jatah hari yang bisa tidak absen dan tetap capai target">Kesempatan Tidak
                                    Absen</p>
                                <h4 class="text-xl font-bold text-blue-400" id="stat-buffer-days">0</h4>
                            </div>
                            <i class="fa-solid fa-couch text-blue-500 text-2xl" id="buffer-icon"></i>
                        </div>

                        <div class="glass-panel p-4 rounded-xl flex items-center justify-between">
                            <div>
                                <p class="text-xs text-slate-400" title="Sisa hari yang harus hadir untuk capai target">
                                    Sisa Target</p>
                                <h4 class="text-xl font-bold text-indigo-400" id="stat-remaining-target">20</h4>
                            </div>
                            <i class="fa-solid fa-bullseye text-indigo-500 text-2xl"></i>
                        </div>
                    </div>

                    <!-- LEGENDA -->
                    <div class="mt-6 p-4 rounded-xl bg-slate-800/30 border border-white/10">
                        <h4 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">Legenda Warna</h4>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-green-500/30 border border-green-500"></div>
                                <span class="text-xs text-slate-300">Hari Kerja Wajib</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-orange-500/30 border border-orange-500"></div>
                                <span class="text-xs text-slate-300">Bisa Absen (Optional)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-red-500/30 border border-red-500"></div>
                                <span class="text-xs text-slate-300">Libur Wajib (Jumat)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-green-500/70 border border-green-500"></div>
                                <span class="text-xs text-slate-300">Sudah Absen</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded border-2 border-indigo-500"></div>
                                <span class="text-xs text-slate-300">Hari Ini</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KALENDER -->
                <div class="glass-panel rounded-2xl overflow-hidden">
                    <div class="p-4 md:p-6 border-b border-white/10 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-white">
                            <i class="fa-solid fa-calendar-days text-indigo-500 mr-2"></i>
                            Kalender Bulan <span id="calendar-month-title">Januari 2026</span>
                        </h3>
                        <button onclick="openHolidaySettings()"
                            class="glass-panel px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-white/5">
                            <i class="fa-solid fa-sliders text-blue-400"></i>
                            <span class="text-sm">Atur Libur</span>
                        </button>
                    </div>

                    <!-- HEADER HARI -->
                    <div class="grid grid-cols-7 gap-1 p-4 border-b border-white/10 bg-slate-800/30">
                        <div class="text-center text-xs font-bold text-slate-400 p-2">Minggu</div>
                        <div class="text-center text-xs font-bold text-slate-400 p-2">Senin</div>
                        <div class="text-center text-xs font-bold text-slate-400 p-2">Selasa</div>
                        <div class="text-center text-xs font-bold text-slate-400 p-2">Rabu</div>
                        <div class="text-center text-xs font-bold text-slate-400 p-2">Kamis</div>
                        <div class="text-center text-xs font-bold text-slate-400 p-2">Jumat</div>
                        <div class="text-center text-xs font-bold text-slate-400 p-2">Sabtu</div>
                    </div>

                    <!-- GRID KALENDER -->
                    <div id="calendar-grid" class="p-4 grid grid-cols-7 gap-1">
                        <!-- Diisi oleh JavaScript -->
                    </div>
                </div>

                <!-- CATATAN PENTING -->
                <div class="glass-panel rounded-2xl p-6">
                    <h4 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-circle-info text-yellow-500"></i>
                        Sistem Absensi Fleksibel
                    </h4>
                    <div class="space-y-3 text-sm text-slate-300">
                        <div class="flex items-start gap-2">
                            <i class="fa-solid fa-check text-green-400 mt-1"></i>
                            <p><span class="font-bold">Bisa Absen:</span> Semua hari <span class="text-red-400">kecuali
                                    Jumat</span> (hari lain tetap bisa absen)</p>
                        </div>
                        <div class="flex items-start gap-2">
                            <i class="fa-solid fa-times text-red-400 mt-1"></i>
                            <p><span class="font-bold">Tidak Bisa Absen:</span> Hanya hari Jumat (libur wajib)</p>
                        </div>
                        <div class="flex items-start gap-2">
                            <i class="fa-solid fa-calendar-plus text-blue-400 mt-1"></i>
                            <p><span class="font-bold">Libur Optional:</span> Hanya untuk penandaan, tetap bisa absen
                            </p>
                        </div>
                        <div class="flex items-start gap-2">
                            <i class="fa-solid fa-bullseye text-indigo-400 mt-1"></i>
                            <p><span class="font-bold">Target:</span> Minimal 20 hari masuk dari total hari yang bisa
                                absen</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL TIDAK HADIR -->
    <div id="absence-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="glass-panel w-full max-w-sm rounded-2xl p-6 relative">
                <h3 class="text-lg font-bold text-white mb-4 text-center">Alasan Tidak Hadir</h3>
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="submitAbsence('Sakit')"
                        class="glass-input hover:bg-slate-700 py-3 rounded-xl font-bold text-white transition-colors">Sakit</button>
                    <button onclick="submitAbsence('Izin')"
                        class="glass-input hover:bg-slate-700 py-3 rounded-xl font-bold text-white transition-colors">Izin</button>
                    <button onclick="submitAbsence('Lainnya')"
                        class="glass-input hover:bg-slate-700 py-3 rounded-xl font-bold text-white transition-colors">Lainnya</button>
                </div>
                <button onclick="closeAbsenceModal()"
                    class="mt-4 text-slate-400 text-sm hover:text-white w-full text-center">Batal</button>
            </div>
        </div>
    </div>

    <!-- PERBAIKAN: MODAL LOGOUT - SIMPLE DAN PASTI BISA DIKLIK -->
    <div id="logout-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="glass-panel w-full max-w-sm rounded-2xl p-6 relative">
                <div class="text-center mb-6">
                    <div
                        class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/30">
                        <i class="fa-solid fa-triangle-exclamation text-2xl text-red-400"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white">Keluar Aplikasi?</h3>
                    <p class="text-slate-400 text-sm mt-2">Anda akan kembali ke halaman login</p>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-6">
                    <button onclick="closeLogoutModal()"
                        class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-xl transition-colors active:scale-95">
                        Batal
                    </button>
                    <button onclick="confirmLogout()"
                        class="bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-4 rounded-xl transition-colors shadow-lg shadow-red-500/20 active:scale-95">
                        Ya, Keluar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ATUR LIBUR KHUSUS & OPTIONAL -->
    <div id="holiday-settings-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="glass-panel w-full max-w-md rounded-2xl relative">
                <div class="p-4 md:p-6">
                    <!-- TOMBOL CLOSE -->
                    <button onclick="closeHolidaySettings()"
                        class="absolute top-4 right-4 text-slate-400 hover:text-white z-10">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>

                    <h3
                        class="text-lg font-bold text-white mb-6 text-center flex items-center justify-center gap-2 pt-1">
                        <i class="fa-solid fa-calendar-plus text-blue-400"></i>
                        Atur Libur Optional & Khusus
                    </h3>

                    <div class="space-y-6 max-h-[65vh] overflow-y-auto pr-2" id="modal-scroll-container">
                        <!-- PENJELASAN SISTEM -->
                        <div class="glass-panel p-4 rounded-xl bg-blue-500/10 border border-blue-500/30">
                            <h4 class="text-sm font-bold text-blue-400 uppercase tracking-wider mb-2">Sistem Absensi
                                Fleksibel</h4>
                            <p class="text-sm text-slate-300">
                                <span class="font-bold">Bisa Absen:</span> Semua hari <span
                                    class="text-red-400 font-bold">kecuali Jumat</span><br>
                                <span class="font-bold">Libur Optional:</span> Hanya penandaan, tetap bisa absen<br>
                                <span class="font-bold">Libur Khusus:</span> Tanggal tertentu yang tidak bisa absen
                            </p>
                        </div>

                        <!-- LIBUR OPTIONAL (HARI DALAM MINGGU) -->
                        <div class="glass-panel p-4 rounded-xl">
                            <h4 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">Pilih Hari Libur
                                Optional</h4>
                            <p class="text-xs text-slate-400 mb-3">Pilih hari yang ingin ditandai sebagai libur
                                optional:</p>
                            <div class="grid grid-cols-2 gap-2" id="optional-days-container">
                                <!-- Diisi oleh JavaScript -->
                            </div>
                            <p class="text-xs text-slate-400 mt-2">
                                <i class="fa-solid fa-info-circle mr-1"></i>
                                Hari yang dipilih hanya penandaan, tetap bisa absen
                            </p>
                        </div>

                        <!-- LIBUR KHUSUS (TANGGAL TERTENTU) -->
                        <div class="glass-panel p-4 rounded-xl">
                            <h4 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">Tambah Libur
                                Khusus</h4>
                            <div class="space-y-3">
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Tanggal
                                        Libur</label>
                                    <input type="date" id="additional-holiday-date"
                                        class="glass-input w-full rounded-lg py-2 px-3 text-sm">
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Keterangan
                                        Libur</label>
                                    <input type="text" id="additional-holiday-name"
                                        class="glass-input w-full rounded-lg py-2 px-3 text-sm"
                                        placeholder="Contoh: Libur Nasional, Cuti, dll">
                                </div>
                                <button onclick="addAdditionalHoliday()"
                                    class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2.5 px-4 rounded-lg transition-colors active:scale-95">
                                    <i class="fa-solid fa-plus mr-2"></i>Tambah Libur Khusus
                                </button>
                            </div>
                        </div>

                        <!-- DAFTAR LIBUR KHUSUS -->
                        <div class="glass-panel p-4 rounded-xl">
                            <h4 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">Daftar Libur
                                Khusus</h4>
                            <div id="additional-holidays-list" class="space-y-2 max-h-32 overflow-y-auto">
                                <!-- Diisi oleh JavaScript -->
                            </div>
                        </div>

                        <!-- CATATAN PENTING -->
                        <div class="glass-panel p-4 rounded-xl bg-yellow-500/10 border border-yellow-500/30">
                            <h4 class="text-sm font-bold text-yellow-400 uppercase tracking-wider mb-2">Catatan Penting
                            </h4>
                            <ul class="text-xs text-slate-300 space-y-1">
                                <li>• <span class="font-bold">Jumat</span> otomatis libur wajib (tidak bisa absen)</li>
                                <li>• <span class="font-bold text-green-400">Semua hari lain bisa absen</span> termasuk
                                    yang ditandai optional</li>
                                <li>• Libur optional hanya untuk penandaan di kalender</li>
                                <li>• Libur khusus adalah tanggal tertentu yang tidak bisa absen</li>
                                <li>• Target minimal: <span class="font-bold">20 hari absen</span> per periode</li>
                            </ul>
                        </div>

                        <div class="grid grid-cols-2 gap-3 pt-4">
                            <button onclick="closeHolidaySettings()"
                                class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-xl transition-colors text-sm active:scale-95">
                                Batal
                            </button>
                            <button onclick="saveHolidaySettings()"
                                class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-xl transition-colors shadow-lg shadow-green-500/20 text-sm active:scale-95">
                                <i class="fa-solid fa-save mr-2"></i>Simpan
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= JAVASCRIPT LOGIC ================= -->
    <script>
        // --- CONFIG ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyCN6C7Sct0iCr5lVnqUy4HVdc6-ROc6xHoZ3Po38u77cwtTUPeiKWfd1M9OOwAxlrRuw/exec';
        const COOKIE_NAME = 'absensi_auth_v7_3';
        const JAM_MASUK = 7;
        const TOLERANSI_MENIT = 1;
        const TARGET_MINIMUM_DAYS = 20; // Minimum 20 hari masuk
        const CUTOFF_DATE = 25; // Tanggal cutoff

        // --- GLOBAL STATE ---
        let currentUser = null;
        let attendanceData = [];
        let calendarData = null;

        // PERBAIKAN: Default kalender berdasarkan tanggal hari ini
        const today = new Date();
        const currentDay = today.getDate();

        // Tentukan bulan default berdasarkan sistem cutoff
        if (currentDay > CUTOFF_DATE) {
            // Jika tanggal > 25, tampilkan bulan selanjutnya
            currentCalendarMonth = today.getMonth() + 2; // +2 karena Januari = 1
            currentCalendarYear = today.getFullYear();
            // Handle overflow ke tahun baru
            if (currentCalendarMonth > 12) {
                currentCalendarMonth = 1;
                currentCalendarYear++;
            }
        } else {
            // Jika tanggal <= 25, tampilkan bulan sekarang
            currentCalendarMonth = today.getMonth() + 1; // +1 karena Januari = 1
            currentCalendarYear = today.getFullYear();
        }

        // SISTEM BARU: Default tidak ada libur optional
        let holidaySettings = {
            additionalHolidays: [], // Array of {date: 'yyyy-mm-dd', name: 'string'} - TIDAK BISA ABSEN
            optionalDays: [] // Array of day numbers (0=Minggu, 1=Senin, ..., 6=Sabtu) - BISA ABSEN
        };

        let deferredPrompt;

        // PERBAIKAN 1: Flag untuk tracking apakah holiday settings sudah di-load
        let holidaySettingsLoaded = false;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            checkSessionCookie();
            setInterval(updateClock, 1000);
            updateDateDisplay();
            setupPasswordToggle();

            // Setup PWA Install Listener
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('beforeinstallprompt fired');
                e.preventDefault();
                deferredPrompt = e;
                showInstallButton();

                // Simpan event untuk digunakan nanti
                window.deferredPrompt = e;
            });

            // Cek apakah sudah terinstall
            window.addEventListener('appinstalled', () => {
                console.log('PWA installed');
                hideInstallButton();
                window.deferredPrompt = null;
            });

            // PERBAIKAN: Tambah event listener untuk modal overlay
            setupModalClickListeners();
        });

        // PERBAIKAN 1: Setup modal click listeners
        function setupModalClickListeners() {
            // Tutup modal ketika klik di luar konten
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        // Tutup modal berdasarkan ID
                        if (this.id === 'logout-modal') {
                            closeLogoutModal();
                        } else if (this.id === 'absence-modal') {
                            closeAbsenceModal();
                        } else if (this.id === 'holiday-settings-modal') {
                            closeHolidaySettings();
                        }
                    }
                });
            });
        }

        // --- PWA INSTALL FUNCTIONS ---
        function showInstallButton() {
            const installBtn = document.getElementById('btn-install-pwa');
            if (installBtn) {
                installBtn.classList.remove('hidden');
                console.log('Install button shown');
            }
        }

        function hideInstallButton() {
            const installBtn = document.getElementById('btn-install-pwa');
            if (installBtn) {
                installBtn.classList.add('hidden');
            }
        }

        async function installApp() {
            if (!deferredPrompt) {
                // Cek apakah sudah ada di cache
                if (window.matchMedia('(display-mode: standalone)').matches) {
                    showToast('Aplikasi sudah terinstall', 'info');
                    return;
                }

                // Coba trigger prompt secara manual
                showToast('Tekan menu browser dan pilih "Add to Home Screen"', 'info');
                return;
            }

            deferredPrompt.prompt();
            const choiceResult = await deferredPrompt.userChoice;

            if (choiceResult.outcome === 'accepted') {
                console.log('User accepted the install prompt');
                showToast('Aplikasi berhasil diinstall!', 'success');
                hideInstallButton();
            } else {
                console.log('User dismissed the install prompt');
                showToast('Installasi dibatalkan', 'info');
            }

            deferredPrompt = null;
        }

        function checkPWAStatus() {
            // Cek apakah sudah standalone (sudah diinstall)
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

            if (isStandalone) {
                console.log('Running as PWA (standalone)');
                hideInstallButton();
            } else if (isIOS) {
                // iOS butuh cara khusus
                console.log('iOS detected - manual install required');
                // Tampilkan instruksi untuk iOS
                showInstallButton();
            } else {
                // Android/Desktop - bisa pakai beforeinstallprompt
                console.log('Waiting for install prompt');
            }
        }

        // --- PASSWORD TOGGLE ---
        function setupPasswordToggle() {
            const togglePassword = document.getElementById('toggle-password');
            const passwordInput = document.getElementById('login-pass');
            const eyeIcon = document.getElementById('eye-icon');

            togglePassword.addEventListener('click', () => {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                eyeIcon.className = type === 'text' ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye';
            });
        }

        // --- COOKIE MANAGEMENT ---
        function setSessionCookie(userObj) {
            const cookieString = encodeURIComponent(JSON.stringify(userObj)) + "; path=/; max-age=" + (10 * 365 * 24 * 60 * 60);
            document.cookie = COOKIE_NAME + "=" + cookieString;
        }

        function getSessionCookie() {
            const nameEQ = COOKIE_NAME + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) {
                    try {
                        const data = decodeURIComponent(c.substring(nameEQ.length, c.length));
                        return JSON.parse(data);
                    } catch (e) { return null; }
                }
            }
            return null;
        }

        function deleteSessionCookie() {
            document.cookie = COOKIE_NAME + '=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        }

        // --- HOLIDAY SETTINGS MANAGEMENT ---
        // PERBAIKAN 1: Fungsi load holiday settings yang optimal
        function loadHolidaySettings() {
            // Jika sudah di-load, langsung render UI
            if (holidaySettingsLoaded) {
                console.log("Holiday settings already loaded, rendering UI");
                renderOptionalDays();
                renderAdditionalHolidaysList();
                return;
            }

            toggleLoading(true, 'Memuat pengaturan libur...');

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'get_holiday_settings',
                    username: currentUser.username
                })
            })
                .then(res => res.json())
                .then(result => {
                    console.log("Load settings response:", result);

                    if (result.status === 'success' && result.settings) {
                        holidaySettings = result.settings;
                        holidaySettingsLoaded = true; // Tandai sudah di-load
                        console.log("Loaded settings from database:", holidaySettings);
                    } else {
                        // Default settings - TIDAK ADA LIBUR OPTIONAL DEFAULT
                        holidaySettings = {
                            additionalHolidays: [],
                            optionalDays: []
                        };
                        holidaySettingsLoaded = true; // Tandai sudah di-load
                        console.log("Using default settings");
                    }

                    // Render UI
                    renderOptionalDays();
                    renderAdditionalHolidaysList();
                })
                .catch(error => {
                    console.error('Error loading holiday settings:', error);
                    // Fallback to localStorage
                    const saved = localStorage.getItem('holiday_settings_v7_3');
                    if (saved) {
                        try {
                            holidaySettings = JSON.parse(saved);
                            holidaySettingsLoaded = true; // Tandai sudah di-load
                            console.log("Loaded from localStorage:", holidaySettings);
                        } catch (e) {
                            holidaySettings = {
                                additionalHolidays: [],
                                optionalDays: []
                            };
                            holidaySettingsLoaded = true; // Tandai sudah di-load
                        }
                    }
                })
                .finally(() => {
                    toggleLoading(false);
                });
        }

        // PERBAIKAN 1: Fungsi untuk load holiday settings sekali saat login
        async function loadHolidaySettingsOnce() {
            if (holidaySettingsLoaded) {
                console.log("Holiday settings already loaded, skipping...");
                return;
            }

            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'get_holiday_settings',
                        username: currentUser.username
                    })
                });

                const result = await res.json();
                console.log("Initial load settings response:", result);

                if (result.status === 'success' && result.settings) {
                    holidaySettings = result.settings;
                    holidaySettingsLoaded = true;
                    console.log("Initial loaded settings:", holidaySettings);
                } else {
                    holidaySettings = {
                        additionalHolidays: [],
                        optionalDays: []
                    };
                    holidaySettingsLoaded = true;
                }
            } catch (error) {
                console.error('Error loading holiday settings:', error);
                const saved = localStorage.getItem('holiday_settings_v7_3');
                if (saved) {
                    try {
                        holidaySettings = JSON.parse(saved);
                        holidaySettingsLoaded = true;
                    } catch (e) {
                        holidaySettings = {
                            additionalHolidays: [],
                            optionalDays: []
                        };
                        holidaySettingsLoaded = true;
                    }
                }
            }
        }

        // PERBAIKAN 1: Fungsi save yang lebih efisien
        async function saveHolidaySettings() {
            toggleLoading(true, 'Menyimpan pengaturan...');

            console.log("Saving settings:", holidaySettings);

            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'save_holiday_settings',
                        username: currentUser.username,
                        password: currentUser.password,
                        settings: holidaySettings
                    })
                });

                const result = await res.json();
                console.log("Save settings response:", result);

                if (result.status === 'success') {
                    // Also save to localStorage as backup
                    localStorage.setItem('holiday_settings_v7_3', JSON.stringify(holidaySettings));

                    showToast('Pengaturan libur berhasil disimpan ke database', 'success');
                    closeHolidaySettings();

                    // PERBAIKAN: Hanya load calendar, TIDAK load holiday settings lagi
                    console.log("Reloading calendar after save...");
                    loadCalendar();
                } else {
                    showToast('Gagal menyimpan ke database: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error saving holiday settings:', error);
                // Fallback to localStorage
                localStorage.setItem('holiday_settings_v7_3', JSON.stringify(holidaySettings));
                showToast('Pengaturan disimpan ke penyimpanan lokal', 'warning');
                closeHolidaySettings();

                // PERBAIKAN: Hanya load calendar, TIDAK load holiday settings lagi
                console.log("Reloading calendar after local save...");
                loadCalendar();
            } finally {
                toggleLoading(false);
            }
        }

        // PERBAIKAN 1: Fungsi open holiday settings yang tidak load ulang
        function openHolidaySettings() {
            console.log("Opening holiday settings modal");

            // Hanya render UI dari data yang sudah ada, TIDAK load ulang dari database
            renderOptionalDays();
            renderAdditionalHolidaysList();

            const modal = document.getElementById('holiday-settings-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex'; // PERBAIKAN: Gunakan flex

            // Scroll ke atas konten modal
            const scrollContainer = document.getElementById('modal-scroll-container');
            if (scrollContainer) {
                scrollContainer.scrollTop = 0;
            }
        }

        function closeHolidaySettings() {
            const modal = document.getElementById('holiday-settings-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }

        function addAdditionalHoliday() {
            const dateInput = document.getElementById('additional-holiday-date');
            const nameInput = document.getElementById('additional-holiday-name');

            if (!dateInput.value || !nameInput.value) {
                showToast('Harap isi tanggal dan keterangan', 'error');
                return;
            }

            const holiday = {
                date: dateInput.value,
                name: nameInput.value.trim()
            };

            // Check duplicate
            const isDuplicate = holidaySettings.additionalHolidays.some(h => h.date === holiday.date);
            if (isDuplicate) {
                showToast('Tanggal libur ini sudah ada', 'error');
                return;
            }

            holidaySettings.additionalHolidays.push(holiday);
            renderAdditionalHolidaysList();

            // Reset form
            dateInput.value = '';
            nameInput.value = '';

            showToast('Libur khusus berhasil ditambahkan', 'success');
        }

        function renderAdditionalHolidaysList() {
            const list = document.getElementById('additional-holidays-list');
            list.innerHTML = '';

            if (holidaySettings.additionalHolidays.length === 0) {
                list.innerHTML = '<p class="text-sm text-slate-500 text-center py-4">Belum ada libur khusus</p>';
                return;
            }

            // Sort by date
            holidaySettings.additionalHolidays.sort((a, b) => new Date(a.date) - new Date(b.date));

            holidaySettings.additionalHolidays.forEach((holiday, index) => {
                const date = new Date(holiday.date);
                const dateFormatted = date.toLocaleDateString('id-ID', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });

                const dayOfWeek = date.getDay();
                const dayName = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'][dayOfWeek];

                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 rounded-lg bg-slate-800/50 animate-fadeIn';
                item.innerHTML = `
                    <div class="flex-1">
                        <p class="font-medium text-white text-sm">${holiday.name}</p>
                        <p class="text-xs text-slate-400">${dateFormatted}</p>
                    </div>
                    <button onclick="removeAdditionalHoliday(${index})" class="text-red-400 hover:text-red-300 ml-3">
                        <i class="fa-solid fa-trash text-sm"></i>
                    </button>
                `;
                list.appendChild(item);
            });
        }

        function removeAdditionalHoliday(index) {
            holidaySettings.additionalHolidays.splice(index, 1);
            renderAdditionalHolidaysList();
        }

        function renderOptionalDays() {
            const container = document.getElementById('optional-days-container');
            const days = [
                { id: 0, name: 'Minggu' },
                { id: 1, name: 'Senin' },
                { id: 2, name: 'Selasa' },
                { id: 3, name: 'Rabu' },
                { id: 4, name: 'Kamis' },
                { id: 6, name: 'Sabtu' }
            ];

            container.innerHTML = '';

            days.forEach(day => {
                const isSelected = holidaySettings.optionalDays.includes(day.id);
                const button = document.createElement('button');
                button.type = 'button';
                button.className = `py-2 px-3 rounded-lg text-sm font-medium transition-colors ${isSelected ? 'bg-orange-500 text-white' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'} active:scale-95`;
                button.textContent = day.name;
                button.onclick = () => toggleOptionalDay(day.id);
                container.appendChild(button);
            });
        }

        function toggleOptionalDay(dayId) {
            const index = holidaySettings.optionalDays.indexOf(dayId);
            if (index > -1) {
                // Remove if already selected
                holidaySettings.optionalDays.splice(index, 1);
            } else {
                // Add if not selected
                holidaySettings.optionalDays.push(dayId);
            }
            renderOptionalDays();
        }

        // --- AUTH LOGIC ---
        async function checkSessionCookie() {
            const session = getSessionCookie();
            const loginPage = document.getElementById('login-page');
            const appPage = document.getElementById('app-page');

            if (session) {
                currentUser = session;
                loginPage.classList.add('hidden');
                appPage.classList.remove('hidden');

                document.getElementById('user-name-display').textContent = currentUser.name || currentUser.username;
                updateDateDisplay();
                initFilters();
                fetchData();

                // PERBAIKAN 1: Load holiday settings sekali saat login
                loadHolidaySettingsOnce();

                // Cek status PWA
                checkPWAStatus();

                // Set active tab UI saat pertama load
                switchTab('home');
            } else {
                loginPage.classList.remove('hidden');
                appPage.classList.add('hidden');
            }
        }

        // Login Form Handler
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();

            toggleLoading(true, 'Mengecek akun...');
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'login', username: u, password: p })
                });
                const result = await res.json();

                if (result.status === 'success') {
                    setSessionCookie({
                        username: result.userData.username,
                        name: result.userData.name,
                        password: p
                    });
                    currentUser = result.userData;
                    currentUser.password = p;

                    showToast('Login Berhasil!', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(result.message, 'error');
                }
            } catch (err) {
                showToast('Gagal terhubung ke server', 'error');
            } finally {
                toggleLoading(false);
            }
        });

        // --- PERBAIKAN: LOGOUT FUNCTIONS ---
        function openLogoutModal() {
            console.log('Opening logout modal');
            const modal = document.getElementById('logout-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex'; // PERBAIKAN: Pastikan flex
        }

        function closeLogoutModal() {
            console.log('Closing logout modal');
            const modal = document.getElementById('logout-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }

        function confirmLogout() {
            console.log('Confirming logout');
            deleteSessionCookie();
            closeLogoutModal();
            setTimeout(() => {
                location.reload();
            }, 300);
        }

        // --- ABSENCE MODAL FUNCTIONS ---
        function openAbsenceModal() {
            const modal = document.getElementById('absence-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        function closeAbsenceModal() {
            const modal = document.getElementById('absence-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }

        // --- DATA & API ---
        async function fetchData() {
            toggleLoading(true, 'Memuat data...');
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'get_data', username: currentUser.username })
                });
                const result = await res.json();

                if (result.status === 'success') {
                    attendanceData = result.data;
                    renderDashboard();

                    // Load calendar jika tab kalender aktif
                    const activeTab = document.querySelector('[id^="tab-"]:not(.hidden)');
                    if (activeTab && activeTab.id === 'tab-calendar') {
                        loadCalendar();
                    }
                }
            } catch (e) {
                showToast('Gagal memuat data', 'error');
            } finally {
                toggleLoading(false);
                document.getElementById('icon-refresh').classList.remove('fa-spin');
            }
        }

        async function doAbsen() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = Minggu, 1 = Senin, ..., 6 = Sabtu

            // Format Tanggal & Jam
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;

            const timeStr = now.toLocaleTimeString('id-ID', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            }).replace(/:/g, '.'); // Ganti : dengan .

            // Validasi: Cek apakah sudah absen hari ini
            if (attendanceData.some(d => d.date === dateStr)) {
                showToast('Sudah absen hari ini!', 'warning');
                loadAllData();
                return;
            }

            // Validasi: Cek apakah hari ini Jumat (libur wajib) - TIDAK BISA ABSEN
            if (dayOfWeek === 5) { // 5 = Jumat
                showToast('Hari Jumat adalah libur wajib, tidak bisa absen!', 'error');
                return;
            }

            // Validasi: Cek apakah hari ini libur khusus - TIDAK BISA ABSEN
            const isSpecialHoliday = holidaySettings.additionalHolidays.some(h => h.date === dateStr);
            if (isSpecialHoliday) {
                const holiday = holidaySettings.additionalHolidays.find(h => h.date === dateStr);
                showToast(`Hari ini libur khusus: ${holiday.name}`, 'error');
                return;
            }

            // LIBUR OPTIONAL BOLEH ABSEN - tidak ada validasi untuk optionalDays

            // --- LOGIKA STATUS DENGAN TOLERANSI ---
            const hour = now.getHours();
            const minute = now.getMinutes();

            const nowTotal = hour * 60 + minute;
            const limitTotal = JAM_MASUK * 60 + TOLERANSI_MENIT;

            let status = 'Tepat Waktu';
            if (nowTotal > limitTotal) status = 'Terlambat';

            let category = 'Hadir';

            await sendAbsenceData(dateStr, timeStr, status, category);
        }

        function submitAbsence(reason) {
            const now = new Date();
            const dayOfWeek = now.getDay();

            // Format Tanggal
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            const timeStr = "--:--";

            // Validasi: Cek apakah sudah absen hari ini
            if (attendanceData.some(d => d.date === dateStr)) {
                closeAbsenceModal();
                showToast('Data hari ini sudah ada!', 'warning');
                loadAllData();
                return;
            }

            // Validasi: Cek apakah hari ini Jumat (libur wajib) - TIDAK BISA ABSEN
            if (dayOfWeek === 5) {
                closeAbsenceModal();
                showToast('Hari Jumat adalah libur wajib!', 'error');
                return;
            }

            // Validasi: Cek apakah hari ini libur khusus - TIDAK BISA ABSEN
            const isSpecialHoliday = holidaySettings.additionalHolidays.some(h => h.date === dateStr);
            if (isSpecialHoliday) {
                closeAbsenceModal();
                const holiday = holidaySettings.additionalHolidays.find(h => h.date === dateStr);
                showToast(`Hari ini libur khusus: ${holiday.name}`, 'error');
                return;
            }

            // LIBUR OPTIONAL BOLEH ABSEN - tidak ada validasi untuk optionalDays

            const status = reason;
            const category = 'Tidak Hadir';

            closeAbsenceModal();
            sendAbsenceData(dateStr, timeStr, status, category);
        }

        async function sendAbsenceData(dateStr, timeStr, status, category) {
            toggleLoading(true, 'Mengirim absensi...');
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'absen',
                        username: currentUser.username,
                        password: currentUser.password,
                        date: dateStr,
                        time: timeStr,
                        status: status,
                        category: category
                    })
                });
                const result = await res.json();

                if (result.status === 'success') {
                    showToast('Berhasil Absen!', 'success');
                    loadAllData(); // Load semua data
                } else {
                    showToast(result.message, 'error');
                }
            } catch (e) {
                showToast('Gagal koneksi', 'error');
            } finally {
                toggleLoading(false);
            }
        }

        function refreshData() {
            document.getElementById('icon-refresh').classList.add('fa-spin');
            loadAllData(); // Load semua data
        }

        // --- CALENDAR FUNCTIONS ---
        // --- CALENDAR FUNCTIONS ---
        // --- CALENDAR FUNCTIONS ---
        function loadCalendar() {
            if (!currentUser) return;

            console.log("Loading calendar with holiday settings:", holidaySettings);

            // Tentukan bulan yang akan ditampilkan berdasarkan currentCalendarMonth dan currentCalendarYear
            const targetDate = new Date(currentCalendarYear, currentCalendarMonth - 1, 1);

            // GENERATE PERIODE CUTOFF berdasarkan bulan yang dipilih
            const currentDay = targetDate.getDate();
            const currentMonth = targetDate.getMonth();
            const currentYear = targetDate.getFullYear();

            // Tentukan periode berdasarkan cutoff tanggal 25
            let startDate, endDate;

            if (currentDay <= CUTOFF_DATE) {
                // Jika tanggal <= 25, periode: 26 bulan SEBELUMNYA - 25 bulan SEKARANG
                if (currentMonth === 0) { // Januari
                    startDate = new Date(currentYear - 1, 11, 26); // 26 Desember tahun lalu
                    endDate = new Date(currentYear, 0, CUTOFF_DATE); // 25 Januari tahun sekarang
                } else {
                    startDate = new Date(currentYear, currentMonth - 1, 26); // 26 bulan sebelumnya
                    endDate = new Date(currentYear, currentMonth, CUTOFF_DATE); // 25 bulan sekarang
                }
            } else {
                // Jika tanggal > 25, periode: 26 bulan SEKARANG - 25 bulan DEPAN
                startDate = new Date(currentYear, currentMonth, 26); // 26 bulan sekarang
                if (currentMonth === 11) { // Desember
                    endDate = new Date(currentYear + 1, 0, CUTOFF_DATE); // 25 Januari tahun depan
                } else {
                    endDate = new Date(currentYear, currentMonth + 1, CUTOFF_DATE); // 25 bulan depan
                }
            }

            // Generate calendar data untuk periode tersebut
            calendarData = generateCalendarDataForPeriod(startDate, endDate);
            renderCalendar();
            updateCalendarStats();
        }

        // Fungsi untuk generate calendar berdasarkan periode
        function generateCalendarDataForPeriod(startDate, endDate) {
            const calendarDays = [];
            const current = new Date(startDate);
            const today = new Date();
            const todayStr = formatDate(today);

            // Reset tanggal current ke awal lagi untuk loop
            current.setTime(startDate.getTime());

            let totalDays = 0;
            let mandatoryWorkingDays = 0;
            let optionalOffDays = 0;
            let fridayDays = 0;
            let totalCanAttend = 0;
            let attendedDays = 0;

            // VARIABEL BARU
            let pastDaysCanAttend = 0;
            let futureDaysCanAttend = 0;
            let todayCanAttend = false;
            let todayHasAttended = false;

            // TAMBAHKAN VARIABEL UNTUK LIBUR OPTIONAL
            let totalOptionalDays = 0;           // Total hari libur optional dalam periode
            let pastOptionalDays = 0;            // Libur optional yang sudah lewat
            let futureOptionalDays = 0;          // Libur optional di masa depan
            let todayIsOptional = false;         // Hari ini libur optional?

            while (current <= endDate) {
                totalDays++;
                const dateStr = formatDate(current);
                const dayOfWeek = current.getDay();
                const dayName = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'][dayOfWeek];
                const dateNum = current.getDate();
                const monthNum = current.getMonth() + 1;
                const yearNum = current.getFullYear();

                const isToday = dateStr === todayStr;
                const hasAttended = attendanceData.some(d => d.date === dateStr && d.category === 'Hadir');

                const currentDate = new Date(dateStr);
                const isPast = currentDate < today;
                const isFuture = currentDate > today;

                // Tentukan jenis hari
                let dayType = '';
                let dayColor = '';
                let canAttend = false;
                let isMissed = false;

                const isAdditionalHoliday = holidaySettings.additionalHolidays.some(h => h.date === dateStr);
                const isOptionalHoliday = holidaySettings.optionalDays.includes(dayOfWeek);
                const isFriday = dayOfWeek === 5;

                if (isAdditionalHoliday) {
                    dayType = 'mandatory-off';
                    dayColor = 'red';
                    canAttend = false;
                } else if (isFriday) {
                    dayType = 'mandatory-off';
                    dayColor = 'red';
                    canAttend = false;
                    fridayDays++;
                } else if (isOptionalHoliday) {
                    dayType = 'optional-off';
                    dayColor = 'orange';
                    canAttend = true;
                    optionalOffDays++;
                    totalOptionalDays++; // Hitung total libur optional

                    // KATEGORIKAN LIBUR OPTIONAL BERDASARKAN WAKTU
                    if (isPast) {
                        pastOptionalDays++;
                    } else if (isFuture) {
                        futureOptionalDays++;
                    } else if (isToday) {
                        todayIsOptional = true;
                    }
                } else {
                    dayType = 'working';
                    dayColor = 'green';
                    canAttend = true;
                    mandatoryWorkingDays++;
                }

                // Hitung statistik berdasarkan waktu
                if (canAttend) {
                    totalCanAttend++;

                    if (isPast) {
                        pastDaysCanAttend++;
                    } else if (isFuture) {
                        futureDaysCanAttend++;
                    } else if (isToday) {
                        todayCanAttend = true;
                        todayHasAttended = hasAttended;
                    }
                }

                if (hasAttended) {
                    attendedDays++;
                }

                if (isPast && canAttend && !hasAttended) {
                    isMissed = true;
                    dayType = 'missed';
                }

                calendarDays.push({
                    date: dateStr,
                    dayName: dayName,
                    dateNum: dateNum,
                    month: monthNum,
                    year: yearNum,
                    dayOfWeek: dayOfWeek,
                    dayType: dayType,
                    dayColor: dayColor,
                    isToday: isToday,
                    hasAttended: hasAttended,
                    canAttend: canAttend,
                    isAdditionalHoliday: isAdditionalHoliday,
                    isOptionalHoliday: isOptionalHoliday,
                    attendanceData: attendanceData.find(d => d.date === dateStr),
                    isPast: isPast,
                    isFuture: isFuture,
                    isMissed: isMissed
                });

                current.setDate(current.getDate() + 1);
            }

            totalCanAttend = mandatoryWorkingDays + optionalOffDays;

            // Hitung sisa kesempatan absen
            let remainingOpportunity = 0;
            if (todayCanAttend && !todayHasAttended) {
                remainingOpportunity = futureDaysCanAttend + 1;
            } else {
                remainingOpportunity = futureDaysCanAttend;
            }
            remainingOpportunity = Math.max(0, remainingOpportunity);

            // Hitung sisa libur optional
            let remainingOptionalDays = futureOptionalDays;
            if (todayIsOptional && !todayHasAttended) {
                remainingOptionalDays += 1; // Hari ini libur optional dan belum absen
            }

            const progressPercent = TARGET_MINIMUM_DAYS > 0 ?
                Math.min(100, Math.round((attendedDays / TARGET_MINIMUM_DAYS) * 100)) : 0;

            return {
                period: {
                    start: formatDateDisplay(startDate),
                    end: formatDateDisplay(endDate),
                    startDate: startDate,
                    endDate: endDate
                },
                stats: {
                    totalDays: totalDays,
                    mandatoryWorkingDays: mandatoryWorkingDays,
                    optionalOffDays: optionalOffDays,
                    fridayDays: fridayDays,
                    totalCanAttend: totalCanAttend,
                    attendedDays: attendedDays,
                    progressPercent: progressPercent,
                    remainingTarget: Math.max(0, TARGET_MINIMUM_DAYS - attendedDays),
                    notAttendedDays: Math.max(0, totalCanAttend - attendedDays),
                    pastDaysCanAttend: pastDaysCanAttend,
                    futureDaysCanAttend: futureDaysCanAttend,
                    todayCanAttend: todayCanAttend,
                    todayHasAttended: todayHasAttended,
                    remainingOpportunity: remainingOpportunity,
                    targetMandatoryAttendance: TARGET_MINIMUM_DAYS,
                    bufferDays: remainingOpportunity - Math.max(0, TARGET_MINIMUM_DAYS - attendedDays),

                    // TAMBAHKAN STATISTIK LIBUR OPTIONAL
                    totalOptionalDays: totalOptionalDays,
                    pastOptionalDays: pastOptionalDays,
                    futureOptionalDays: futureOptionalDays,
                    todayIsOptional: todayIsOptional,
                    remainingOptionalDays: remainingOptionalDays
                },
                days: calendarDays
            };
        }

        function renderCalendar() {
            if (!calendarData) {
                console.log("No calendar data to render");
                return;
            }

            console.log("Rendering calendar with", calendarData.days.length, "days");

            // Update displays
            document.getElementById('calendar-period-display').textContent =
                `${calendarData.period.start} - ${calendarData.period.end}`;
            document.getElementById('calendar-month-title').textContent =
                getMonthName(currentCalendarMonth) + ' ' + currentCalendarYear;

            // Update statistics
            document.getElementById('stat-total-days').textContent = calendarData.stats.totalDays;
            document.getElementById('stat-mandatory-working').textContent = calendarData.stats.mandatoryWorkingDays;
            document.getElementById('stat-optional-off').textContent = calendarData.stats.optionalOffDays;
            document.getElementById('stat-can-attend').textContent = calendarData.stats.totalCanAttend;

            // Render calendar grid
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            // Get first day of period for spacing
            const firstDayOfWeek = calendarData.days[0].dayOfWeek; // 0 = Minggu

            // Add empty cells for days before start of period
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day rounded-lg bg-slate-900/30 border border-slate-800/50';
                grid.appendChild(emptyCell);
            }

            // Render each day
            calendarData.days.forEach(day => {
                const dayElement = document.createElement('div');
                const todayClass = day.isToday ? 'day-today' : '';

                dayElement.className = `calendar-day rounded-lg flex flex-col p-2 cursor-pointer transition-all ${getDayClass(day)} ${todayClass} animate-fadeIn`;

                // Add attendance indicator
                let attendanceBadge = '';
                if (day.hasAttended) {
                    attendanceBadge = '<div class="absolute top-1 right-1 w-3 h-3 rounded-full bg-green-500 border border-white"></div>';
                }

                // Add holiday icon if special holiday
                let holidayIcon = '';
                if (day.isAdditionalHoliday) {
                    holidayIcon = '<div class="absolute top-1 left-1 text-[10px] text-red-400">★</div>';
                } else if (day.isOptionalHoliday) {
                    holidayIcon = '<div class="absolute top-1 left-1 text-[10px] text-orange-400">○</div>';
                }

                // PERBAIKAN: Determine day text berdasarkan status
                let dayText = '';
                let dayTextColor = '';

                if (day.hasAttended) {
                    dayText = '✓ Hadir';
                    dayTextColor = 'text-green-400';
                } else if (day.isAdditionalHoliday) {
                    dayText = 'Libur Khusus';
                    dayTextColor = 'text-red-400';
                } else if (day.isOptionalHoliday) {
                    const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                    dayText = `Libur ${dayNames[day.dayOfWeek]}`;
                    dayTextColor = 'text-orange-400';
                } else if (day.dayOfWeek === 5) { // Jumat
                    dayText = 'Libur Wajib';
                    dayTextColor = 'text-red-400';
                } else if (day.isMissed) {
                    // PERBAIKAN: Hari terlewat dan belum absen
                    dayText = 'Tidak Absen';
                    dayTextColor = 'text-slate-400';
                } else {
                    dayText = 'Bisa Absen';
                    dayTextColor = 'text-green-400';
                }

                // PERBAIKAN: Determine number color
                let numberClass = '';
                if (day.isToday) {
                    numberClass = 'text-white font-bold';
                } else if (day.hasAttended) {
                    numberClass = 'text-white';
                } else if (day.isMissed) {
                    // PERBAIKAN: Hari terlewat - angka abu-abu
                    numberClass = 'text-slate-300';
                } else {
                    numberClass = 'text-slate-300';
                }

                dayElement.innerHTML = `
            <div class="relative">
                ${attendanceBadge}
                ${holidayIcon}
                <div class="text-xs ${day.dayColor === 'red' ? 'text-red-400' : day.dayColor === 'orange' ? 'text-orange-400' : 'text-slate-400'} mb-1">
                    ${day.dayName.substring(0, 3)}
                </div>
                <div class="text-lg font-bold ${numberClass}">
                    ${day.dateNum}
                </div>
            </div>
            <div class="mt-auto text-[10px] ${dayTextColor}">${dayText}</div>
        `;

                grid.appendChild(dayElement);
            });
        }

        function getDayClass(day) {
            let baseClass = '';

            // PERBAIKAN: Urutan pengecekan penting
            if (day.hasAttended) {
                baseClass = 'day-attended';
            } else if (day.isMissed) {
                // PERBAIKAN: Hari terlewat dan belum absen - warna outline saja
                baseClass = 'day-missed';
            } else if (day.dayType === 'mandatory-off') {
                baseClass = 'day-mandatory-off';
            } else if (day.dayType === 'optional-off') {
                baseClass = 'day-optional-off';
            } else if (day.dayType === 'working') {
                baseClass = 'day-working';
            }

            return baseClass;
        }

        function updateCalendarStats() {
            if (!calendarData) return;

            const stats = calendarData.stats;

            // Update semua statistik yang sudah ada...
            document.getElementById('stat-total-days').textContent = stats.totalDays;

            if (document.getElementById('stat-mandatory-attendance')) {
                document.getElementById('stat-mandatory-attendance').textContent = TARGET_MINIMUM_DAYS + ' hari';
            }

            document.getElementById('stat-mandatory-working').textContent = stats.mandatoryWorkingDays;
            document.getElementById('stat-optional-off').textContent = stats.optionalOffDays;
            document.getElementById('stat-can-attend').textContent = stats.totalCanAttend;
            document.getElementById('stat-total-attended').textContent = stats.attendedDays;
            document.getElementById('stat-attended-days').textContent = stats.attendedDays;
            document.getElementById('stat-not-attended').textContent = stats.remainingOpportunity;
            document.getElementById('stat-remaining-target').textContent = stats.remainingTarget;

            // ========== UPDATE SISA LIBUR OPTIONAL DENGAN ICON ==========
            const remainingOptionalElement = document.getElementById('stat-remaining-optional');
            const optionalIcon = document.getElementById('optional-icon'); // ← TAMBAH INI

            if (remainingOptionalElement && optionalIcon) {
                remainingOptionalElement.textContent = stats.remainingOptionalDays;

                // Warna dan icon berdasarkan jumlah
                if (stats.remainingOptionalDays > 0) {
                    // Ada libur optional tersisa
                    remainingOptionalElement.className = 'text-xl font-bold text-orange-400';
                    optionalIcon.className = 'fa-solid fa-calendar-star text-orange-500 text-2xl';

                    // OPTIONAL: Icon berubah-ubah berdasarkan jumlah
                    if (stats.remainingOptionalDays >= 5) {
                        optionalIcon.className = 'fa-solid fa-party-horn text-orange-500 text-2xl'; // Banyak libur
                    } else if (stats.remainingOptionalDays >= 3) {
                        optionalIcon.className = 'fa-solid fa-star text-orange-500 text-2xl'; // Cukup libur
                    } else {
                        optionalIcon.className = 'fa-solid fa-calendar-star text-orange-500 text-2xl'; // Sedikit libur
                    }
                } else {
                    // Tidak ada libur optional tersisa
                    remainingOptionalElement.className = 'text-xl font-bold text-slate-400';
                    optionalIcon.className = 'fa-solid fa-calendar-star text-slate-500 text-2xl';
                }
            }

            // Update tooltip untuk Sisa Libur Optional
            const optionalDescription = document.querySelector('#stat-remaining-optional')?.parentElement?.querySelector('p.text-xs');
            if (optionalDescription) {
                if (stats.remainingOptionalDays > 0) {
                    optionalDescription.title = `Masih ada ${stats.remainingOptionalDays} hari libur optional di masa depan`;
                } else {
                    optionalDescription.title = 'Tidak ada hari libur optional tersisa';
                }
            }
            // ========== END UPDATE ==========

            // Update Kesempatan Tidak Absen (buffer)
            const remainingOpportunity = stats.remainingOpportunity;
            const remainingTarget = stats.remainingTarget;
            const bufferDays = remainingOpportunity - remainingTarget;

            const bufferElement = document.getElementById('stat-buffer-days');
            const bufferIcon = document.getElementById('buffer-icon');

            if (bufferElement && bufferIcon) {
                bufferElement.textContent = bufferDays;

                if (bufferDays > 0) {
                    bufferElement.className = 'text-xl font-bold text-blue-400';
                    bufferIcon.className = 'fa-solid fa-couch text-blue-500 text-2xl';
                } else if (bufferDays === 0) {
                    bufferElement.className = 'text-xl font-bold text-yellow-400';
                    bufferIcon.className = 'fa-solid fa-exclamation-triangle text-yellow-500 text-2xl';
                } else {
                    bufferElement.className = 'text-xl font-bold text-red-400';
                    bufferIcon.className = 'fa-solid fa-running text-red-500 text-2xl';
                }
            }

            // Update progress bar...
            const progressText = `${stats.attendedDays}/${TARGET_MINIMUM_DAYS}`;
            const progressPercent = Math.min(100, Math.round((stats.attendedDays / TARGET_MINIMUM_DAYS) * 100));

            document.getElementById('stat-progress').textContent = progressText;
            document.getElementById('stat-progress-percent').textContent = `${progressPercent}%`;
            document.getElementById('progress-bar').style.width = `${progressPercent}%`;

            const progressBar = document.getElementById('progress-bar');
            if (progressPercent < 50) {
                progressBar.className = 'bg-red-500 h-2 rounded-full transition-all duration-500';
            } else if (progressPercent < 80) {
                progressBar.className = 'bg-yellow-500 h-2 rounded-full transition-all duration-500';
            } else {
                progressBar.className = 'bg-green-500 h-2 rounded-full transition-all duration-500';
            }
        }

        function prevCalendarMonth() {
            currentCalendarMonth--;
            if (currentCalendarMonth < 1) {
                currentCalendarMonth = 12;
                currentCalendarYear--;
            }
            loadCalendar();
        }

        function nextCalendarMonth() {
            currentCalendarMonth++;
            if (currentCalendarMonth > 12) {
                currentCalendarMonth = 1;
                currentCalendarYear++;
            }
            loadCalendar();
        }

        // --- UI RENDERING ---
        function renderDashboard() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const todayDateStr = `${year}-${month}-${day}`;

            const todayData = attendanceData.find(d => d.date === todayDateStr);
            const btn = document.getElementById('btn-absen');
            const statCont = document.getElementById('status-container');

            if (todayData) {
                btn.disabled = true;
                const btnText = todayData.category === 'Tidak Hadir' ? 'SELESAI (TIDAK HADIR)' : 'SELESAI';
                btn.innerHTML = `<i class="fa-solid fa-check text-4xl"></i><span>${btnText}</span>`;
                btn.classList.add('opacity-50');
                statCont.classList.remove('hidden');

                const displayTime = todayData.time === '--:--' ? todayData.status : formatTimeNoSec(todayData.time);
                document.getElementById('status-text').textContent = `${todayData.status} (${displayTime})`;

                let dotColor = 'bg-green-500';
                if (todayData.status === 'Terlambat') dotColor = 'bg-red-500';
                if (todayData.category === 'Tidak Hadir') dotColor = 'bg-yellow-500';
                document.getElementById('status-dot').className = `w-2 h-2 rounded-full ${dotColor} animate-pulse`;

            } else {
                btn.disabled = false;
                btn.innerHTML = `<i class="fa-solid fa-fingerprint text-4xl animate-pulse"></i><span>ABSEN</span>`;
                btn.classList.remove('opacity-50');
                statCont.classList.add('hidden');
            }

            // STATS
            const pid = getPeriodID(new Date());
            const pData = attendanceData.filter(d => {
                const dd = new Date(d.date);
                return getPeriodID(dd) === pid;
            });

            const totalHadir = pData.filter(d => d.category === 'Hadir').length;
            const totalTidakHadir = pData.filter(d => d.category === 'Tidak Hadir').length;
            const totalTerlambat = pData.filter(d => d.status === 'Terlambat').length;

            // Update Stats Home
            animateNum('stat-total', totalHadir);
            animateNum('stat-absent', totalTidakHadir);
            animateNum('stat-late', totalTerlambat);

            renderRecap();
        }

        function renderRecap() {
            const tbody = document.getElementById('recap-body');
            const empty = document.getElementById('recap-empty');
            const mVal = parseInt(document.getElementById('filter-month').value);
            const yVal = parseInt(document.getElementById('filter-year').value);

            tbody.innerHTML = '';
            const filtered = attendanceData.filter(d => {
                const dd = new Date(d.date);
                return getPeriodID(dd) === `${yVal}-${mVal}`;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));

            // Hitung Total Hadir Periode Ini
            const cumHadir = filtered.filter(d => d.category === 'Hadir').length;
            const totalTidakHadir = filtered.filter(d => d.category === 'Tidak Hadir').length;
            const totalTerlambat = filtered.filter(d => d.status === 'Terlambat').length;

            // Update Stats Recap
            document.getElementById('recap-stat-total').innerText = cumHadir;
            document.getElementById('recap-stat-absent').innerText = totalTidakHadir;
            document.getElementById('recap-stat-late').innerText = totalTerlambat;

            if (filtered.length === 0) {
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                filtered.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-white/5 transition-colors";

                    // Format: Hari, Tanggal
                    const dateObj = new Date(row.date);
                    const dayName = dateObj.toLocaleDateString('id-ID', { weekday: 'long' });
                    const dateOnly = dateObj.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });

                    // Format Jam
                    const timeDisplay = row.time === '--:--' ? row.status : formatTimeNoSec(row.time);

                    let badgeClass = "bg-green-500/20 text-green-400 border border-green-500/30";
                    let statusText = row.status;

                    if (row.status === 'Terlambat') {
                        badgeClass = "bg-red-500/20 text-red-400 border border-red-500/30";
                    } else if (row.category === 'Tidak Hadir') {
                        badgeClass = "bg-yellow-500/20 text-yellow-400 border border-yellow-500/30";
                    }

                    tr.innerHTML = `
                        <td class="p-4">
                            <div class="text-white font-medium">${dayName}</div>
                            <div class="text-xs text-slate-400">${dateOnly}</div>
                        </td>
                        <td class="p-4 font-mono text-slate-200">${timeDisplay}</td>
                        <td class="p-4"><span class="px-2 py-1 rounded-md text-xs font-bold ${badgeClass}">${statusText}</span></td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        // --- UTILS & NAVIGATION ---
        function switchTab(tab) {
            // Hide all tabs
            document.getElementById('tab-home').classList.add('hidden');
            document.getElementById('tab-recap').classList.add('hidden');
            document.getElementById('tab-calendar').classList.add('hidden');

            // Show selected tab
            document.getElementById(`tab-${tab}`).classList.remove('hidden');

            // Update UI untuk Desktop
            const desktopBtns = document.querySelectorAll('.nav-item');
            desktopBtns.forEach(btn => {
                const isTarget = btn.id === `btn-tab-${tab}`;

                if (isTarget) {
                    // Style Active Desktop
                    btn.classList.remove('text-slate-400', 'hover:text-white', 'hover:bg-white/5');
                    btn.classList.add('text-white', 'bg-white/10');
                } else {
                    // Style Non-Active Desktop
                    btn.classList.remove('text-white', 'bg-white/10');
                    btn.classList.add('text-slate-400', 'hover:text-white', 'hover:bg-white/5');
                }
            });

            // Update UI untuk Mobile
            const mobileBtns = document.querySelectorAll('.nav-item-mobile');
            mobileBtns.forEach(btn => {
                const isTarget = btn.id === `btn-tab-${tab}-mobile`;

                if (isTarget) {
                    // Style Active Mobile
                    btn.classList.remove('text-slate-400');
                    btn.classList.add('text-white', 'bg-white/10');
                } else {
                    // Style Non-Active Mobile
                    btn.classList.remove('text-white', 'bg-white/10');
                    btn.classList.add('text-slate-400');
                }
            });

            // Load calendar data if calendar tab is selected
            if (tab === 'calendar' && currentUser) {
                console.log("Switching to calendar tab, loading calendar...");
                loadCalendar();
            }
        }

        function initFilters() {
            const ms = document.getElementById('filter-month');
            const ys = document.getElementById('filter-year');
            const months = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];

            months.forEach((m, i) => ms.innerHTML += `<option value="${i}">${m}</option>`);

            const cy = new Date().getFullYear();
            for (let i = cy - 2; i <= cy + 1; i++) ys.innerHTML += `<option value="${i}">${i}</option>`;

            // Set default active period
            const now = new Date();
            const pid = getPeriodID(now).split('-');
            ms.value = parseInt(pid[1]);
            ys.value = parseInt(pid[0]);
        }

        function getPeriodID(d) {
            const day = d.getDate();
            let m = d.getMonth(), y = d.getFullYear();
            if (day >= 26) { m++; if (m > 11) { m = 0; y++; } }
            return `${y}-${m}`;
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateDisplay(date) {
            const day = date.getDate();
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            const month = monthNames[date.getMonth()];
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        }

        function formatTimeNoSec(timeStr) {
            if (!timeStr) return "";
            let s = String(timeStr).trim();
            s = s.replace(/(\.00)+$/, "");
            return s;
        }

        function getMonthName(month) {
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            return months[month - 1];
        }

        function updateClock() {
            document.getElementById('live-clock').textContent = new Date().toLocaleTimeString('id-ID', { hour12: false });
        }

        function updateDateDisplay() {
            document.getElementById('date-display').textContent = new Date().toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function toggleLoading(show, txt) {
            const el = document.getElementById('loading-overlay');
            document.getElementById('loading-text').textContent = txt;
            if (show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        function showToast(msg, type) {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            const bg = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-yellow-500');
            const ic = type === 'success' ? 'fa-check' : (type === 'error' ? 'fa-xmark' : 'fa-info');
            t.className = `toast glass-panel px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 min-w-[280px] border-l-4 ${type === 'success' ? 'border-green-500' : (type === 'error' ? 'border-red-500' : 'border-yellow-500')}`;
            t.innerHTML = `<div class="${bg} w-6 h-6 rounded-full flex items-center justify-center text-xs text-white shrink-0"><i class="fa-solid ${ic}"></i></div><span class="text-sm font-medium text-white">${msg}</span>`;
            c.appendChild(t);
            setTimeout(() => {
                t.style.opacity = '0';
                t.style.transform = 'translateY(-10px)';
                setTimeout(() => t.remove(), 300);
            }, 3000);
        }

        function animateNum(id, target) {
            const el = document.getElementById(id);
            const s = parseInt(el.innerText);
            if (s === target) return;
            const d = target - s;
            const dur = 500;
            let cur = s;
            const timer = setInterval(() => {
                cur += (d > 0 ? 1 : -1);
                el.innerText = cur;
                if (cur === target) clearInterval(timer);
            }, Math.max(10, dur / Math.abs(d)));
        }

        // --- LOAD ALL DATA ---
        async function loadAllData() {
            await fetchData();
            if (document.getElementById('tab-calendar').classList.contains('hidden') === false) {
                loadCalendar();
            }
        }
    </script>
</body>

</html>
