<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        primary: '#6366f1',
                        secondary: '#a855f7',
                        surface: '#1e293b',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; overflow-x: hidden; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-card { background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%); border: 1px solid rgba(255, 255, 255, 0.05); }
        .text-gradient { background: linear-gradient(to right, #818cf8, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Toast */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 100; }
        .toast { transform: translateX(100%); transition: transform 0.3s; }
        .toast.show { transform: translateX(0); }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">
    <div id="toast-container" class="flex flex-col gap-3"></div>
    <div id="app" class="flex-grow flex flex-col"></div>

    <script>
        // ==========================================
        // GANTI URL API DI SINI
        // ==========================================
        const API_URL = 'PASTE_URL_APPS_SCRIPT_ANDA_DISINI'; 

        // State Global
        let currentUser = null;
        let allUsersCache = [];
        let globalRekapData = []; // Cache untuk data rekap saat ini

        // --- HELPER FUNCTIONS ---
        async function callAppsScript(action, payload = {}) {
            if (!API_URL || API_URL.includes('PASTE_URL')) {
                showToast("URL API Belum dikonfigurasi!", "error");
                return null;
            }
            try {
                let url = API_URL;
                let options = { method: 'POST', body: JSON.stringify({ action, ...payload }) };
                
                // Menggunakan POST untuk semua request agar lebih aman dan payload besar
                const response = await fetch(url, options);
                const result = await response.json();
                return result;
            } catch (error) {
                console.error("API Error:", error);
                showToast("Gagal koneksi ke Server", "error");
                return null;
            }
        }

        function formatTanggalIndo(dateString) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const d = new Date(dateString);
            return d.toLocaleDateString('id-ID', options);
        }

        // Generate Opsi Bulan (Mundur 12 bulan ke belakang)
        function getMonthOptions() {
            const options = [];
            const today = new Date();
            for (let i = 0; i < 12; i++) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = d.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
                options.push({ value, label });
            }
            return options;
        }

        // Menghitung Start & End date berdasarkan Bulan yang dipilih (Tgl 1 - Akhir Bulan)
        // Atau Logika Gaji (Tgl 26 Bulan lalu - Tgl 25 Bulan ini). 
        // Disini saya pakai Full Month (Tgl 1 - Akhir) agar lebih umum, bisa diubah jika perlu.
        function getDateRangeFromMonth(yyyyMmString) {
            const [year, month] = yyyyMmString.split('-');
            const startDate = `${year}-${month}-01`;
            // Cari tanggal terakhir bulan tersebut
            const lastDay = new Date(year, month, 0).getDate();
            const endDate = `${year}-${month}-${lastDay}`;
            return { startDate, endDate };
        }

        // --- AUTHENTICATION ---
        async function initApp() {
            const session = localStorage.getItem('absensi_session');
            if (session) {
                currentUser = JSON.parse(session);
                renderApp();
            } else {
                renderLogin();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            const btn = e.target.querySelector('button');
            
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Loading...';
            btn.disabled = true;

            const res = await callAppsScript('getUsers');
            
            if (res && res.status === 'success') {
                allUsersCache = res.data;
                const user = allUsersCache.find(d => d.username === u && d.password === p);
                if (user) {
                    localStorage.setItem('absensi_session', JSON.stringify(user));
                    currentUser = user;
                    showToast(`Login Berhasil`, 'success');
                    renderApp();
                } else {
                    showToast('Username/Password Salah', 'error');
                }
            } else {
                showToast('Gagal memuat data user', 'error');
            }
            btn.innerHTML = 'Masuk';
            btn.disabled = false;
        }

        function handleLogout() {
            localStorage.removeItem('absensi_session');
            currentUser = null;
            window.location.hash = '';
            renderLogin();
        }

        // --- CORE LOGIC ---
        async function handleAbsen() {
            const btn = document.getElementById('btnAbsen');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Proses...';
            
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
            const timeString = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            
            // Logika Terlambat (Contoh: Lewat jam 07:00)
            const isLate = now.getHours() > 7 || (now.getHours() === 7 && now.getMinutes() > 0);
            const status = isLate ? 'Terlambat' : 'Tepat Waktu';
            
            const res = await callAppsScript('absen', {
                userId: currentUser.id,
                userName: currentUser.name,
                date: dateStr,
                time: timeString,
                status: status
            });

            if (res && res.status === 'success') {
                showToast("Absensi Berhasil!", "success");
                renderAbsensiGuru(); // Refresh halaman
            } else {
                showToast(res ? res.message : "Gagal Absen", "error");
                btn.disabled = false;
                btn.innerHTML = 'Absen Sekarang';
            }
        }

        // --- RENDERING ---
        function renderLogin() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4 bg-slate-900">
                    <div class="glass-panel p-8 rounded-2xl shadow-2xl w-full max-w-md fade-in">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-white">Absensi<span class="text-gradient">Pro</span></h1>
                            <p class="text-slate-400">Silakan login</p>
                        </div>
                        <form id="loginForm" class="space-y-6">
                            <input type="text" id="username" class="w-full p-3 bg-slate-800 rounded-xl text-white border border-slate-700" placeholder="Username" required>
                            <input type="password" id="password" class="w-full p-3 bg-slate-800 rounded-xl text-white border border-slate-700" placeholder="Password" required>
                            <button type="submit" class="w-full bg-primary hover:bg-indigo-600 text-white font-bold py-3 rounded-xl transition-all">Masuk</button>
                        </form>
                    </div>
                </div>`;
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }

        function renderLayout(contentHTML, activeId) {
            const isMobile = window.innerWidth < 768;
            const sidebarHTML = `
                <aside class="${isMobile ? 'hidden' : 'w-64'} fixed inset-y-0 left-0 glass-panel z-50 flex flex-col transition-all">
                    <div class="p-6 text-2xl font-bold text-primary">Absensi<span class="text-white">App</span></div>
                    <nav class="flex-1 px-4 space-y-2 mt-4">
                        ${getNavLink('dashboard', 'Dashboard', 'fa-chart-pie', currentUser.role === 'Admin')}
                        ${getNavLink('absensi', 'Absensi', 'fa-fingerprint', currentUser.role === 'Guru')}
                        ${getNavLink('rekap', 'Rekap Data', 'fa-table-list', true)}
                    </nav>
                    <div class="p-4 border-t border-slate-700">
                        <div class="text-sm text-white mb-2 font-bold">${currentUser.name}</div>
                        <button onclick="handleLogout()" class="text-red-400 text-sm hover:text-red-300"><i class="fa-solid fa-arrow-right-from-bracket"></i> Logout</button>
                    </div>
                </aside>
                ${isMobile ? `
                <div class="fixed top-0 w-full glass-panel z-40 p-4 flex justify-between items-center">
                    <span class="font-bold text-primary">AbsensiPro</span>
                    <button onclick="document.getElementById('mobileMenu').classList.toggle('hidden')"><i class="fa-solid fa-bars text-xl"></i></button>
                </div>
                <div id="mobileMenu" class="hidden fixed top-14 left-0 w-full glass-panel z-30 p-4 flex flex-col gap-2 border-b border-slate-700">
                     ${getNavLink('dashboard', 'Dashboard', 'fa-chart-pie', currentUser.role === 'Admin', true)}
                     ${getNavLink('absensi', 'Absensi', 'fa-fingerprint', currentUser.role === 'Guru', true)}
                     ${getNavLink('rekap', 'Rekap Data', 'fa-table-list', true, true)}
                     <button onclick="handleLogout()" class="text-left px-4 py-2 text-red-400">Logout</button>
                </div>` : ''}
                <main class="${isMobile ? 'pt-20 px-4' : 'ml-64 p-8'} min-h-screen fade-in pb-20">
                    ${contentHTML}
                </main>
            `;
            document.getElementById('app').innerHTML = sidebarHTML;
        }

        function getNavLink(id, label, icon, show, isMobile) {
            if (!show) return '';
            const isActive = window.location.hash === `#${id}`;
            const cls = `flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${isActive ? 'bg-primary/20 text-primary' : 'text-slate-400 hover:text-white'}`;
            return `<a href="#${id}" onclick="${isMobile ? `document.getElementById('mobileMenu').classList.add('hidden')` : ''}" class="${cls}"><i class="fa-solid ${icon} w-6"></i> ${label}</a>`;
        }

        // --- PAGE: DASHBOARD ADMIN ---
        async function renderDashboardAdmin() {
            const today = new Date().toISOString().split('T')[0];
            renderLayout('<div class="flex justify-center mt-10"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-primary"></i></div>', 'dashboard');
            
            const res = await callAppsScript('getRekap', { role: 'Admin', userId: currentUser.id, startDate: today, endDate: today });
            const data = (res && res.status === 'success') ? res.data : [];

            const hadir = data.length;
            const telat = data.filter(x => x.status === 'Terlambat').length;
            const tepat = hadir - telat;

            const html = `
                <h2 class="text-2xl font-bold mb-6">Dashboard Admin</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="glass-card p-6 rounded-2xl border-l-4 border-primary">
                        <p class="text-slate-400">Total Hadir Hari Ini</p>
                        <p class="text-4xl font-bold mt-2">${hadir}</p>
                    </div>
                    <div class="glass-card p-6 rounded-2xl border-l-4 border-green-500">
                        <p class="text-slate-400">Tepat Waktu</p>
                        <p class="text-4xl font-bold text-green-400 mt-2">${tepat}</p>
                    </div>
                    <div class="glass-card p-6 rounded-2xl border-l-4 border-yellow-500">
                        <p class="text-slate-400">Terlambat</p>
                        <p class="text-4xl font-bold text-yellow-400 mt-2">${telat}</p>
                    </div>
                </div>
                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="font-bold mb-4">Aktivitas Terbaru</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-800 text-slate-400 uppercase text-xs"><tr><th class="px-4 py-3">Nama</th><th class="px-4 py-3">Jam</th><th class="px-4 py-3">Status</th></tr></thead>
                            <tbody class="divide-y divide-slate-700">${data.map(r => `<tr><td class="px-4 py-3">${r.userName}</td><td class="px-4 py-3">${r.time}</td><td class="px-4 py-3"><span class="${r.status==='Terlambat'?'text-yellow-400':'text-green-400'}">${r.status}</span></td></tr>`).join('')}</tbody>
                        </table>
                        ${data.length === 0 ? '<p class="text-center py-4 text-slate-500">Belum ada data hari ini</p>' : ''}
                    </div>
                </div>
            `;
            renderLayout(html, 'dashboard');
        }

        // --- PAGE: ABSENSI GURU ---
        async function renderAbsensiGuru() {
            renderLayout('<div class="flex justify-center mt-10"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-primary"></i></div>', 'absensi');

            // Ambil data bulan ini untuk statistik
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
            const todayStr = now.toISOString().split('T')[0];

            const res = await callAppsScript('getRekap', { 
                role: 'Guru', userId: currentUser.id, startDate: startOfMonth, endDate: endOfMonth 
            });
            const history = (res && res.status === 'success') ? res.data : [];

            // Statistik
            const totalHadir = history.length;
            const totalTelat = history.filter(x => x.status === 'Terlambat').length;
            const totalTepat = history.filter(x => x.status === 'Tepat Waktu' || x.status === 'Hadir').length;

            // Status Hari Ini
            const todayRecord = history.find(x => x.date === todayStr);
            let statusText = "Belum Absen";
            let statusColor = "text-slate-400";
            let jamAbsen = "-";

            if (todayRecord) {
                statusText = todayRecord.status; // "Terlambat" atau "Tepat Waktu"
                jamAbsen = todayRecord.time;
                statusColor = statusText === 'Terlambat' ? 'text-yellow-400' : 'text-green-400';
            }

            const html = `
                <div class="max-w-4xl mx-auto space-y-6">
                    <div class="flex justify-between items-end">
                        <div>
                            <h2 class="text-2xl font-bold">Menu Absensi</h2>
                            <p class="text-slate-400">${formatTanggalIndo(todayStr)}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-3 md:gap-6">
                        <div class="glass-card p-4 rounded-xl text-center">
                            <p class="text-xs text-slate-400 uppercase">Hadir</p>
                            <p class="text-2xl font-bold text-white mt-1">${totalHadir}</p>
                        </div>
                        <div class="glass-card p-4 rounded-xl text-center">
                            <p class="text-xs text-slate-400 uppercase">Tepat Waktu</p>
                            <p class="text-2xl font-bold text-green-400 mt-1">${totalTepat}</p>
                        </div>
                        <div class="glass-card p-4 rounded-xl text-center">
                            <p class="text-xs text-slate-400 uppercase">Terlambat</p>
                            <p class="text-2xl font-bold text-yellow-400 mt-1">${totalTelat}</p>
                        </div>
                    </div>

                    <div class="glass-panel p-8 rounded-2xl text-center relative overflow-hidden">
                         <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary to-secondary"></div>
                         
                         <div class="mb-6">
                            <div class="text-sm text-slate-400 mb-1">Status Hari Ini</div>
                            <div class="text-3xl font-bold ${statusColor} mb-2">${statusText}</div>
                            ${todayRecord ? `<div class="inline-block bg-slate-800 px-4 py-1 rounded-full text-sm text-white">Jam Masuk: ${jamAbsen}</div>` : ''}
                         </div>

                         ${!todayRecord ? `
                            <div class="mb-6">
                                <div class="text-6xl font-mono text-white tracking-wider" id="liveClock">00:00:00</div>
                            </div>
                            <button id="btnAbsen" onclick="handleAbsen()" class="w-full md:w-1/2 bg-gradient-to-r from-primary to-secondary hover:shadow-lg hover:shadow-primary/50 text-white font-bold py-4 rounded-xl transition-all transform hover:-translate-y-1">
                                <i class="fa-solid fa-fingerprint mr-2"></i> Absen Masuk
                            </button>
                         ` : `
                            <div class="p-4 bg-green-500/10 border border-green-500/30 rounded-xl text-green-400">
                                <i class="fa-solid fa-check-circle text-2xl mb-2"></i><br>
                                Anda sudah melakukan presensi hari ini.
                            </div>
                         `}
                    </div>
                    
                    </div>
            `;
            renderLayout(html, 'absensi');
            
            // Jam Hidup
            if (!todayRecord) {
                const interval = setInterval(() => {
                    const el = document.getElementById('liveClock');
                    if(el) el.innerText = new Date().toLocaleTimeString('id-ID');
                    else clearInterval(interval);
                }, 1000);
            }
        }

        // --- PAGE: REKAP DATA ---
        async function renderRekap() {
            renderLayout('<div class="flex justify-center mt-10"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-primary"></i></div>', 'rekap');
            
            // Default: Bulan ini
            const monthOpts = getMonthOptions();
            const currentMonthVal = monthOpts[0].value; 
            
            // Render wadah dulu agar dropdown bisa di-insert
            const htmlContainer = `
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold">Rekapitulasi Data</h2>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-slate-400">Periode:</label>
                        <select id="monthFilter" onchange="loadRekapTable(this.value)" class="bg-slate-800 border border-slate-700 text-white text-sm rounded-lg focus:ring-primary focus:border-primary block p-2.5">
                            ${monthOpts.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div id="rekapTableContainer">
                    <div class="flex justify-center py-10"><i class="fa-solid fa-circle-notch fa-spin text-2xl text-slate-500"></i></div>
                </div>
            `;
            renderLayout(htmlContainer, 'rekap');
            
            // Load Data Awal
            loadRekapTable(currentMonthVal);
        }

        async function loadRekapTable(monthVal) {
            const container = document.getElementById('rekapTableContainer');
            container.innerHTML = '<div class="flex justify-center py-10"><i class="fa-solid fa-circle-notch fa-spin text-2xl text-slate-500"></i></div>';
            
            const { startDate, endDate } = getDateRangeFromMonth(monthVal);
            
            const res = await callAppsScript('getRekap', { 
                role: currentUser.role, 
                userId: currentUser.id, 
                startDate, 
                endDate 
            });
            const data = (res && res.status === 'success') ? res.data : [];
            
            if (data.length === 0) {
                container.innerHTML = `<div class="glass-panel p-8 text-center text-slate-400">Tidak ada data pada periode ini.</div>`;
                return;
            }

            let tableHTML = '';
            
            if (currentUser.role === 'Admin') {
                // Admin: Group by User atau List Semua
                // Kita list semua lalu enable search bisa lebih simpel, atau rekap per guru
                // Di sini saya buat rekap per guru agar lebih informatif
                
                // Ambil list unik user dari data users (cache)
                if(allUsersCache.length === 0) await callAppsScript('getUsers'); // ensure users loaded
                
                tableHTML = `
                <div class="glass-panel rounded-2xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-800 text-slate-400 uppercase text-xs">
                                <tr>
                                    <th class="px-6 py-3">Nama Guru</th>
                                    <th class="px-6 py-3 text-center">Hadir</th>
                                    <th class="px-6 py-3 text-center">Tepat Waktu</th>
                                    <th class="px-6 py-3 text-center">Terlambat</th>
                                    <th class="px-6 py-3 text-center">Detail</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-700">
                `;
                
                const guruList = allUsersCache.filter(u => u.role === 'Guru');
                guruList.forEach(guru => {
                    const myData = data.filter(d => d.userId === guru.id);
                    const hadir = myData.length;
                    const telat = myData.filter(d => d.status === 'Terlambat').length;
                    const tepat = hadir - telat;
                    
                    tableHTML += `
                        <tr class="hover:bg-slate-700/50">
                            <td class="px-6 py-4 font-medium text-white">${guru.name}</td>
                            <td class="px-6 py-4 text-center">${hadir}</td>
                            <td class="px-6 py-4 text-center text-green-400">${tepat}</td>
                            <td class="px-6 py-4 text-center text-yellow-400">${telat}</td>
                            <td class="px-6 py-4 text-center">
                                <button class="text-primary hover:text-white" onclick="alert('Detail ${guru.name}: ${myData.map(x=>x.date).join(', ')}')"><i class="fa-solid fa-eye"></i></button>
                            </td>
                        </tr>
                    `;
                });
                tableHTML += `</tbody></table></div></div>`;
                
            } else {
                // Guru: Lihat detail sendiri
                tableHTML = `
                <div class="glass-panel rounded-2xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-800 text-slate-400 uppercase text-xs">
                                <tr>
                                    <th class="px-6 py-3">Tanggal</th>
                                    <th class="px-6 py-3">Jam Masuk</th>
                                    <th class="px-6 py-3">Status</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-700">
                `;
                
                // Sort by date desc
                data.sort((a,b) => b.date.localeCompare(a.date));
                
                data.forEach(row => {
                    const statusColor = row.status === 'Terlambat' ? 'text-yellow-400 bg-yellow-400/10' : 'text-green-400 bg-green-400/10';
                    tableHTML += `
                        <tr class="hover:bg-slate-700/50">
                            <td class="px-6 py-4">${formatTanggalIndo(row.date)}</td>
                            <td class="px-6 py-4 font-mono text-slate-300">${row.time}</td>
                            <td class="px-6 py-4">
                                <span class="px-3 py-1 rounded-full text-xs font-bold ${statusColor}">${row.status}</span>
                            </td>
                        </tr>
                    `;
                });
                tableHTML += `</tbody></table></div></div>`;
            }

            container.innerHTML = tableHTML;
        }

        // --- ROUTER ---
        function renderApp() {
            if (!currentUser) { renderLogin(); return; }
            const hash = window.location.hash.replace('#', '') || 'dashboard';

            if (hash === 'dashboard') {
                if (currentUser.role === 'Admin') renderDashboardAdmin();
                else renderAbsensiGuru(); // Guru default ke Absensi
            } else if (hash === 'absensi') {
                if (currentUser.role === 'Guru') renderAbsensiGuru();
                else renderDashboardAdmin();
            } else if (hash === 'rekap') {
                renderRekap();
            } else {
                // Fallback
                if (currentUser.role === 'Admin') renderDashboardAdmin();
                else renderAbsensiGuru();
            }
        }

        window.addEventListener('hashchange', renderApp);
        window.addEventListener('load', initApp);
    </script>
</body>
</html>
